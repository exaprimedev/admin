<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>EXaPrime Admin</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="css/metisMenu.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="css/dataTables/dataTables.bootstrap.css" rel="stylesheet">

    <!-- DataTables Responsive CSS -->
    <link href="css/dataTables/dataTables.responsive.css" rel="stylesheet">

    <!-- Timeline CSS -->
    <link href="css/timeline.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/startmin.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="css/morris.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap-datepicker -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
     <![endif]-->
</head>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">EXaPrime Admin</a>
            </div>

            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>

            <!-- Top Navigation: Left Menu -->
            <ul class="nav navbar-nav navbar-left navbar-top-links">
                <li><a target="_blank" href="https://exaprimedev.github.io/test/"><i class="fa fa-home fa-fw"></i>HP</a></li>
            </ul>

            <!-- Top Navigation: Right Menu -->
            <ul class="nav navbar-right navbar-top-links" id="top-links">
            </ul>

            <!-- Sidebar -->
            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="container-fluid">

                <div class="row" id="row_inout_title">
                    <div class="col-lg-12">
                        <h3 class="page-header" id="datetime"></h3>
                    </div>
                </div>
                <div class="row" id="row_inout">
                    <div class="col-lg-6">
                        <form id="attendannce_record_in_form" role="form">
                            <fieldset>
                                <div class="form-group" style="display: none;">
                                    <input class="form-control" id="attendannce_record_in_form_mail" name="entry.201600831" type="email">
                                </div>
                                <button type="submit" class="btn btn-info btn-lg btn-block" id="btnIn">出勤</button>
                            </fieldset>
                        </form>
                    </div>
                    <div class="col-lg-6">
                        <form id="attendannce_record_out_form" role="form">
                            <fieldset>
                                <div class="form-group" style="display: none;">
                                    <input class="form-control" id="attendannce_record_out_form_mail" name="entry.1944725173" type="email">
                                </div>
                                <button type="submit" class="btn btn-success btn-lg btn-block" id="btnOut">退勤</button>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="row" id="row_mypage_title" style="display: none;">
                    <div class="col-lg-12">
                        <h3 class="page-header">マイページ</h3>
                    </div>
                </div>
                <div class="row" id="row_mypage_contents" style="display: none;"></div>
                <div class="row" id="row_news_title">
                    <div class="col-lg-12">
                        <h3 class="page-header">お知らせ</h3>
                    </div>
                </div>
                <div class="row" id="row_news_contents">

                </div>

                <div class="row" id="row_docs_title" style="display: none;">
                    <div class="col-lg-12">
                        <h3 class="page-header">共有ドキュメント</h3>
                    </div>
                </div>
                <div class="row" id="row_docs_contents" style="display: none;">
                    <div class="col-lg-12">

                        <div class="panel-group" id="accordion">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" class="">Collapsible Group Item #1</a>
                                    </h4>
                                </div>
                                <div id="collapseOne" class="panel-collapse collapse in" aria-expanded="true" style="">
                                    <div class="panel-body">
                                        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor
                                        in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" class="collapsed" aria-expanded="false">Collapsible Group Item #2</a>
                                    </h4>
                                </div>
                                <div id="collapseTwo" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
                                    <div class="panel-body">
                                        <div class="list-group">
                                            <a target="_blank" href="https://drive.google.com/open?id=1fr4oT_PWqPbnb9C6-XYRK1z1LplGpmsq" class="list-group-item">
                                                <i class="fa fa-file-pdf-o fa-fw"></i> セミナー_人工知能サミット2019
                                                <span class="pull-right text-muted small"><em>yasuhiro.tojima@exaprime.co.jp</em>
                                                </span>
                                            </a>

                                            <a target="_blank" href="https://drive.google.com/open?id=1bEErKJfAuYVeblvFukcPTX4s_84GKNua" class="list-group-item">
                                                <i class="fa fa-file-pdf-o fa-fw"></i> 情報セキュリティについて
                                                <span class="pull-right text-muted small"><em>keisuke.mani@exaprime.co.jp</em>
                                                </span>
                                            </a>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" class="collapsed" aria-expanded="false">Collapsible Group Item #3</a>
                                    </h4>
                                </div>
                                <div id="collapseThree" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
                                    <div class="panel-body">
                                        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor
                                        in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="row" id="row_project_summary_title">
                    <div class="col-lg-12">
                        <h3 class="page-header">プロジェクト管理</h3>
                    </div>
                </div>
                <div class="row" id="row_project_summary_contents"></div>

                <!-- /.row -->

                <div class="row" id="row_dataTables_title" style="display: none;">

                </div>
                <div class="row" id="row_dataTables" style="display: none;">
                    <div class="col-lg-12">
                        <div class="panel panel-default">
                            <div class="panel-heading" id="dataTables_panel_header">
                            </div>
                            <!-- /.panel-heading -->
                            <div class="panel-body">
                                <div class="table-responsive" id="output_dataTables">
                                </div>
                            </div>
                            <!-- /.panel-body -->
                        </div>
                        <!-- /.panel -->
                    </div>
                    <!-- /.col-lg-12 -->
                </div>

                <div class="row" id="row_transportation_costs_contents" style="display: none;">
                    <div class="panel-body">
                        <form id="transportation_costs_form" role="form">
                            <fieldset>
                                <div class="form-group" style="display: none;">
                                    <label>メールアドレス</label>
                                    <input class="form-control" id="transportation_costs_form_mail" name="entry.354726009" type="email" autofocus required>
                                </div>
                                <div class="form-group">
                                    <label>日付</label>
                                    <input data-provide="datepicker" class="form-control datepicker" id="transportation_costs_form_date" required>
                                    <input type="hidden" name="entry.1448482430_year" id="transportation_costs_form_year">
                                    <input type="hidden" name="entry.1448482430_month" id="transportation_costs_form_month">
                                    <input type="hidden" name="entry.1448482430_day" id="transportation_costs_form_day">
                                </div>
                                <div class="form-group">
                                    <label>交通手段</label>
                                    <select class="form-control" id="transportation_costs_form_means" name="entry.1418923752">
                                        <option>電車</option>
                                        <option>バス</option>
                                        <option>タクシー</option>
                                        <option>飛行機</option>
                                        <option>その他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>利用区間From</label>
                                    <input class="form-control" id="transportation_costs_form_from" name="entry.118744780" required>
                                </div>
                                <div class="form-group">
                                    <label>利用区間To</label>
                                    <input class="form-control" id="transportation_costs_form_to" name="entry.946747124" required>
                                </div>
                                <div class="form-group">
                                    <label>金額</label>
                                    <input class="form-control" id="transportation_costs_form_costs" name="entry.197575203" required>
                                </div>
                                <div class="form-group">
                                    <label>備考</label>
                                    <textarea class="form-control" rows="3" id="transportation_costs_form_note" name="entry.1285850841"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success btn-block">申請</button>
                            </fieldset>
                        </form>
                    </div>
                    <div class="alert alert-success" style="display: none;">
                        Lorem ipsum dolor sit amet, consectetur adipisicing elit. <a href="#" class="alert-link">Alert Link</a>.
                    </div>
                </div>
                <!-- ... Your content goes here ... -->

            </div>
        </div>

    </div>

    <!-- jQuery -->
    <script src="js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="js/metisMenu.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="js/dataTables/jquery.dataTables.min.js"></script>
    <script src="js/dataTables/dataTables.bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/startmin.js"></script>

    <!-- Bootstrap-datepicker -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.ja.min.js"></script>

    <!-- オーバーレイのCDN -->
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.6/dist/loadingoverlay.min.js"></script>

    <!-- excelダウンロードのCDN -->
    <script type="text/javascript" src="https://unpkg.com/xlsx/dist/shim.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script type="text/javascript" src="https://unpkg.com/blob.js@1.0.1/Blob.js"></script>
    <script type="text/javascript" src="https://unpkg.com/file-saver@1.3.3/FileSaver.js"></script>

    <!-- firebaseのスクリプト -->
    <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase-auth.js"></script>

    <script>
        const config = {
            apiKey: "AIzaSyArEg2nQofEnSJAdHhq86VsQHugfD-vfb8",
            authDomain: "exaprime-dev-admin.firebaseapp.com",
        };
        const admin_user = ["hiroshi.katou@exaprime.co.jp", "takashi.miura@exaprime.co.jp"];
        const url_user = 'https://script.google.com/macros/s/AKfycbztaNYCMJKZczlxj5nXD2L1Ac-nR9thkeLOyqz-BsXAs5iBNrc/exec';
        const url_pj = 'https://script.google.com/macros/s/AKfycbyPWuArH5REnTsv0CBBVh-EyVDfyOfgXzgBYJdKrvQpzKXMWyI/exec';
        const url_iw = 'https://script.google.com/macros/s/AKfycbwdDBd2Fckq0Lnzf2yZMTOxB-fWuE0_B4Rxl-0azNEqpdSyJ0kA/exec';
        const url_atr = 'https://script.google.com/macros/s/AKfycbz4M2vKlT_VLl4vUSj3YASs9OhaedReWW-0T59u_Ij1v3W1BMw/exec';
        const url_attendannce_record_in_form = 'https://docs.google.com/forms/d/e/1FAIpQLSfUvu5sVp3xGOCoW04o0q_zcUMZFvMumAorfMpK-c9R8RnMOw/formResponse';
        const url_attendannce_record_out_form = 'https://docs.google.com/forms/d/e/1FAIpQLSdY7tSdAoLYvRUQFA8MhxBbkDpGXVbpjo3sSdMGetVLrw0GuQ/formResponse';
        const url_transportation_costs_form = 'https://docs.google.com/forms/d/e/1FAIpQLSeoAXl6SYjF2T1G3mfRQm5XFZrvKXmAugtL9kIV4gRKvoW78A/formResponse';
        const holidayList = [{
            "holiday": "2019/11/3",
            "name": "文化の日"
        }, {
            "holiday": "2019/11/4",
            "name": "休日"
        }, {
            "holiday": "2019/11/23",
            "name": "勤労感謝の日"
        }, {
            "holiday": "2020/1/1",
            "name": "元日"
        }, {
            "holiday": "2020/1/13",
            "name": "成人の日"
        }, {
            "holiday": "2020/2/11",
            "name": "建国記念の日"
        }, {
            "holiday": "2020/2/23",
            "name": "天皇誕生日"
        }, {
            "holiday": "2020/2/24",
            "name": "休日"
        }, {
            "holiday": "2020/3/20",
            "name": "春分の日"
        }, {
            "holiday": "2020/4/29",
            "name": "昭和の日"
        }, {
            "holiday": "2020/5/3",
            "name": "憲法記念日"
        }, {
            "holiday": "2020/5/4",
            "name": "みどりの日"
        }, {
            "holiday": "2020/5/5",
            "name": "こどもの日"
        }, {
            "holiday": "2020/5/6",
            "name": "休日"
        }, {
            "holiday": "2020/7/23",
            "name": "海の日"
        }, {
            "holiday": "2020/7/24",
            "name": "スポーツの日"
        }, {
            "holiday": "2020/8/10",
            "name": "山の日"
        }, {
            "holiday": "2020/9/21",
            "name": "敬老の日"
        }, {
            "holiday": "2020/9/22",
            "name": "秋分の日"
        }, {
            "holiday": "2020/11/3",
            "name": "文化の日"
        }, {
            "holiday": "2020/11/23",
            "name": "勤労感謝の日"
        }];
        $(function() {
            firebase.initializeApp(config);
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // ログイン認証済
                    console.log(new Date() + ' type：auth success：auth user', user);
                    $.LoadingOverlay("show");
                    $("#attendannce_record_in_form_mail").val(user.email);
                    $("#attendannce_record_out_form_mail").val(user.email);
                    $("#transportation_costs_form_mail").val(user.email);
                    $("#top-links").html(createTopLinksHTML(user.email));
                    console.log(new Date() + ' type：html success：createTopLinksHTML');
                    var menu_home = '<li><a href="index.html" class="active"><i class="fa fa-dashboard fa-fw"></i> Home</a></li>';
                    var menu_pj = '';
                    var menu_iw = '';
                    $.ajax({
                            type: 'GET',
                            url: url_user + '?sn=user_list',
                            dataType: 'jsonp',
                            jsonpCallback: 'jsondata'
                        })
                        .then(
                            function(user_list) {
                                console.log(new Date() + ' type：ajax success：sn=user_list');
                                $.ajax({
                                        type: 'GET',
                                        url: url_atr + '?sn=in&q=' + user.email,
                                        dataType: 'jsonp',
                                        jsonpCallback: 'jsondata'
                                    })
                                    .then(
                                        function(in_user) {
                                            console.log(new Date() + ' type：ajax success：sn=in');
                                            // 出勤ボタン制御
                                            atrBtnControl("In", in_user);
                                            console.log(new Date() + ' type：html success：atrBtnControl in');
                                            // マイページ：当月勤怠表HTML作成
                                            createAtrMonthHTML(user.email, user_list, 0, 0);
                                            console.log(new Date() + ' type：html success：createAtrMonthHTML');
                                            $.ajax({
                                                    type: 'GET',
                                                    url: url_atr + '?sn=out&q=' + user.email,
                                                    dataType: 'jsonp',
                                                    jsonpCallback: 'jsondata'
                                                })
                                                .then(
                                                    function(out_user) {
                                                        console.log(new Date() + ' type：ajax success：sn=out');
                                                        // 退勤ボタン制御
                                                        atrBtnControl("Out", out_user);
                                                        console.log(new Date() + ' type：html success：atrBtnControl out');
                                                        $.ajax({
                                                                type: 'GET',
                                                                url: url_pj + '?sn=project_management',
                                                                dataType: 'jsonp',
                                                                jsonpCallback: 'jsondata'
                                                            })
                                                            .then(
                                                                function(project_management) {
                                                                    console.log(new Date() + ' type：ajax success：sn=project_management');
                                                                    // サイトメニュー作成：プロジェクト管理
                                                                    menu_pj = createMenuHTML('pj', project_management);
                                                                    console.log(new Date() + ' type：html success：createMenuHTML project_management');
                                                                    // TOPページコンテンツ作成描画：プロジェクト管理
                                                                    $("#row_project_summary_contents").html(createPanelHTML(project_management));
                                                                    console.log(new Date() + ' type：html success：createPanelHTML');
                                                                    $.ajax({
                                                                            type: 'GET',
                                                                            url: url_iw + '?sn=inner_work_management',
                                                                            dataType: 'jsonp',
                                                                            jsonpCallback: 'jsondata'
                                                                        })
                                                                        .then(
                                                                            function(inner_work_management) {
                                                                                console.log(new Date() + ' type：ajax success：sn=inner_work_management');
                                                                                // サイトメニュー作成：社内業務管理
                                                                                menu_iw = createMenuHTML('iw', inner_work_management);
                                                                                // サイトメニュー描画
                                                                                $("#side-menu").html(menu_home + menu_pj + menu_iw);
                                                                                console.log(new Date() + ' type：html success：createMenuHTML inner_work_management');
                                                                                $.ajax({
                                                                                        type: 'GET',
                                                                                        url: url_iw + '?sn=notifications',
                                                                                        dataType: 'jsonp',
                                                                                        jsonpCallback: 'jsondata'
                                                                                    })
                                                                                    .then(
                                                                                        function(notifications) {
                                                                                            console.log(new Date() + ' type：ajax success：sn=notifications');
                                                                                            // TOPページコンテンツ作成描画：お知らせ
                                                                                            $("#row_news_contents").html(createNewsHTML(notifications));
                                                                                            console.log(new Date() + ' type：html success：createNewsHTML');
                                                                                            $.LoadingOverlay("hide");
                                                                                        },
                                                                                        function() {
                                                                                            console.log('error：sn=notifications');
                                                                                        }
                                                                                    );
                                                                            },
                                                                            function() {
                                                                                console.log('error：sn=inner_work_management');
                                                                            }
                                                                        );
                                                                },
                                                                function() {
                                                                    console.log('error：sn=project_management');
                                                                }
                                                            );
                                                    },
                                                    function() {
                                                        console.log('error：sn=out');
                                                    }
                                                );
                                        },
                                        function() {
                                            console.log('error：sn=in');
                                        }
                                    );
                            },
                            function() {
                                console.log('error：sn=user_list');
                            }
                        );


                    $('.datepicker').datepicker({
                        format: "yyyy/mm/dd",
                        language: 'ja',
                        autoclose: true
                    });
                    $("#attendannce_record_in_form").submit(function(event) {
                        var attendannce_record_in_form_mail = $("#attendannce_record_in_form_mail").val();
                        $.ajax({
                            url: url_attendannce_record_in_form,
                            data: {
                                "entry.201600831": attendannce_record_in_form_mail,
                            },
                            type: "POST",
                            dataType: "xml",
                            statusCode: {
                                0: function() {
                                    alert("出勤しました。");
                                    $("#btnIn").prop("disabled", true);
                                },
                                200: function() {
                                    alert("errorMsg")
                                }
                            }
                        })
                        event.preventDefault();
                    });
                    $("#attendannce_record_out_form").submit(function(event) {
                        var attendannce_record_out_form_mail = $("#attendannce_record_out_form_mail").val();
                        $.ajax({
                            url: url_attendannce_record_out_form,
                            data: {
                                "entry.1944725173": attendannce_record_out_form_mail,
                            },
                            type: "POST",
                            dataType: "xml",
                            statusCode: {
                                0: function() {
                                    alert("退勤しました。")
                                    $("#btnOut").prop("disabled", true);
                                },
                                200: function() {
                                    alert("errorMsg")
                                }
                            }
                        })
                        event.preventDefault();
                    });
                    $("#transportation_costs_form").submit(function(event) {
                        var transportation_costs_form_mail = $("#transportation_costs_form_mail").val();
                        var transportation_costs_form_year = $("#transportation_costs_form_date").val().split("/")[0];
                        var transportation_costs_form_month = $("#transportation_costs_form_date").val().split("/")[1];
                        var transportation_costs_form_day = $("#transportation_costs_form_date").val().split("/")[2];
                        var transportation_costs_form_means = $("#transportation_costs_form_means").val();
                        var transportation_costs_form_from = $("#transportation_costs_form_from").val();
                        var transportation_costs_form_to = $("#transportation_costs_form_to").val();
                        var transportation_costs_form_costs = $("#transportation_costs_form_costs").val();
                        var transportation_costs_form_note = $("#transportation_costs_form_note").val();
                        $.ajax({
                            url: url_transportation_costs_form,
                            data: {
                                "entry.354726009": transportation_costs_form_mail,
                                "entry.1448482430_year": transportation_costs_form_year,
                                "entry.1448482430_month": transportation_costs_form_month,
                                "entry.1448482430_day": transportation_costs_form_day,
                                "entry.1418923752": transportation_costs_form_means,
                                "entry.118744780": transportation_costs_form_from,
                                "entry.946747124": transportation_costs_form_to,
                                "entry.197575203": transportation_costs_form_costs,
                                "entry.1285850841": transportation_costs_form_note
                            },
                            type: "POST",
                            dataType: "xml",
                            statusCode: {
                                0: function() {
                                    alert("交通費精算を申請しました。")
                                },
                                200: function() {
                                    alert("errorMsg")
                                }
                            }
                        })
                        event.preventDefault();
                    });
                } else {
                    window.location.href = "login.html";
                }
            });

        });

        function renderContents(book, sheet_name, sheet_name_jp, link, type) {
            $(".row").hide();
            $("#row_dataTables_title").show();
            $("#row_dataTables").show();
            createDataTables(book, sheet_name, sheet_name_jp, link);
            if (type == "form") {
                $("#row_" + sheet_name + "_contents").show();
            }
        }

        function createTopLinksHTML(email) {
            var out_toplinks = '<li>';
            out_toplinks += '<a class="dropdown-toggle" id="userId" data-toggle="dropdown" href="#" aria-expanded="true">';
            out_toplinks += '<i class="fa fa-user fa-fw"></i>' + email + '<b class="caret"></b>';
            out_toplinks += '</a>';
            out_toplinks += '<ul class="dropdown-menu dropdown-user">';
            out_toplinks += '<li><a href="#" onclick="renderMyPage(\'' + email + '\')"><i class="fa fa-user fa-fw"></i>マイページ</a>';
            out_toplinks += '</li>';
            out_toplinks += '<li><a href="#" onclick="signOut()"><i class="fa fa-sign-out fa-fw"></i>ログアウト</a>';
            out_toplinks += '</li>';
            out_toplinks += '</ul>';
            out_toplinks += '</li>';
            return out_toplinks;
        }

        function createNewsHTML(data) {
            var out_news = '';
            for (var idx in data) {
                out_news += '<div class="col-lg-3 col-md-6">';
                out_news += '<div class="panel panel-default">';
                out_news += '<div class="panel-heading">' + data[idx].日時 + '：' + data[idx].タイトル + '</div>';
                out_news += '<div class="panel-body"><p>' + data[idx].内容 + '(' + data[idx].更新者 + ')</p></div>';
                out_news += '</div>';
                out_news += '</div>';
            }
            return out_news;
        }

        function createMenuHTML(book, data) {
            var out_memu = '';
            var tmplv1st = '';
            var tmplv1end = '';
            var tmplv2st = '';
            var tmplv2end = '';
            var tmplv3 = '';

            for (var idx in data) {
                if (data[idx].level == 1) {
                    tmplv1st += '<li>';
                    tmplv1st += '<a href="#" onclick="toggleMenu(this); return false;"><i class="fa fa-sitemap fa-fw"></i>' + data[idx].sheet_name_jp + '<span class="fa arrow"></span></a>';
                    tmplv1end += '</li>';
                } else if (data[idx].level == 2) {
                    tmplv2st += '<ul class="nav nav-second-level" style="display: none;"><li><a href="#" onclick="renderContents(\'' + book + '\',\'' + data[idx].sheet_name + '\',\'' + data[idx].sheet_name_jp + '\',\'' + data[idx].link + '\',\'' + data[idx].type + '\')">' + data[idx].sheet_name_jp + '</a></li>';
                    tmplv2end += '</ul>';
                } else if (data[idx].level == 3) {
                    tmplv3 += '<li><a href="#" onclick="renderContents(\'' + book + '\',\'' + data[idx].sheet_name + '\',\'' + data[idx].sheet_name_jp + '\',\'' + data[idx].link + '\',\'' + data[idx].type + '\')">' + data[idx].sheet_name_jp + '</a></li>';
                }
            }
            out_memu += tmplv1st + tmplv2st + tmplv3 + tmplv2end + tmplv1end;
            return out_memu
        }

        function createPanelHTML(data) {
            var out_panel = '';
            for (var idx in data) {
                if (data[idx].level > 1) {
                    out_panel += '<div class="' + data[idx].class_grid + '">'
                    out_panel += '<div class="' + data[idx].class_panel + '">'
                    out_panel += '<div class="panel-heading">'
                    out_panel += '<div class="row">'
                    out_panel += '<div class="col-xs-3">'
                    out_panel += '<i class="' + data[idx].class_icon + '"></i>'
                    out_panel += '</div>'
                    out_panel += '<div class="col-xs-9 text-right">'
                    out_panel += '<div class="huge">' + data[idx].rows + '</div>'
                    out_panel += '<div>' + data[idx].comment + '!</div>'
                    out_panel += '</div>'
                    out_panel += '</div>'
                    out_panel += '</div>'
                    out_panel += '<a href="#" onclick="renderContents(\'pj\',\'' + data[idx].sheet_name + '\',\'' + data[idx].sheet_name_jp + '\',\'' + data[idx].link + '\',\'' + data[idx].type + '\')">'
                    out_panel += '<div class="panel-footer">'
                    out_panel += '<span class="pull-left">' + data[idx].sheet_name_jp + '</span>'
                    out_panel += '<span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>'
                    out_panel += '<div class="clearfix"></div>'
                    out_panel += '</div>'
                    out_panel += '</a>'
                    out_panel += '</div>'
                    out_panel += '</div>'
                }
            }
            return out_panel
        }

        function createDataTables(book, sheet_name, sheet_name_jp, link) {
            var url;
            var btnSheetLink = '<span style="font-size:20px">' + sheet_name_jp + '</span>';
            if (sheet_name != "transportation_costs") {
                btnSheetLink = '<span style="font-size:20px">' + sheet_name_jp + '</span><span class="pull-right"><a class="btn btn-primary btn-sm" id="btnSheetLink" target="_blank" href="' + link + '">更新</a></span><div class="clearfix"></div>';
            }

            if (book == "pj") {
                url = url_pj + '?sn=' + sheet_name;
                $("#row_dataTables_title").html('<div class="col-lg-12"><h3 class="page-header">プロジェクト管理</h3></div>');
            } else {
                url = url_iw + '?sn=' + sheet_name;
                $("#row_dataTables_title").html('<div class="col-lg-12"><h3 class="page-header">社内業務管理</h3></div>');
                if (sheet_name == "transportation_costs") {
                    url += '&q=' + $("#userId")[0].innerText;
                }
            }
            $("#dataTables_panel_header").html(btnSheetLink);
            $.ajax({
                    type: 'GET',
                    url: url,
                    dataType: 'jsonp',
                    jsonpCallback: 'jsondata'
                })
                .then(
                    function(result) {
                        var arrHeader = new Array();
                        for (var key in result[0]) {
                            arrHeader.push((new Function("return " + '{data:"' + key + '"}'))());
                        }
                        $("#output_dataTables").html(createDataTablesHTML(arrHeader));
                        $('#datatable').DataTable({
                            destroy: true,
                            data: result,
                            autoWidth: false,
                            columns: arrHeader
                        });
                    },
                    function() {
                        console.log('error');
                    }
                );
        }

        function createDataTablesHTML(arrHeader) {
            var out_thead = '<table class="table table-striped table-bordered table-hover" id="datatable">';
            out_thead += '<thead>';
            out_thead += '<tr>';
            for (var idx in arrHeader) {
                out_thead += '<th>' + arrHeader[idx].data + '</th>';
            }
            out_thead += '</thead>';
            out_thead += '</tr>';
            out_thead += '</table>';
            return out_thead
        }

        function toggleMenu(obj) {
            $(obj).next('ul').slideToggle();
        }

        function atrBtnControl(status, data) {
            for (var idx in data) {
                if (new Date(data[idx].タイムスタンプ).toLocaleString("ja").split(" ")[0] == new Date($('#datetime').html().substr(0, 10)).toLocaleString("ja").split(" ")[0]) {
                    $("#btn" + status).prop("disabled", true);
                }
            }
        }

        function renderMyPage(email) {
            $.LoadingOverlay("show");
            $(".row").hide();
            $("#row_mypage_title").show();
            $("#row_mypage_contents").show();
            console.log('renderMyPage');
            $.ajax({
                    type: 'GET',
                    url: url_atr + '?sn=in&q=' + email,
                    dataType: 'jsonp',
                    jsonpCallback: 'jsondata'
                })
                .then(
                    function(data) {
                        var objTr = $("#tblAtr").find("tr");
                        for (var trIdx = 2; trIdx < objTr.length; trIdx++) {
                            var objTd = objTr[trIdx].cells
                            $("#" + objTd[1].id).html("");
                            $("#" + objTd[2].id).html("");
                            $("#" + objTd[3].id).html("");
                        }
                        // 開始の書き込み
                        for (var idx in data) {
                            var arrTs = new Date(data[idx].タイムスタンプ).toLocaleString("ja").split(" ");
                            var arrTshhmm = arrTs[1].split(":");
                            var arrTsyyyymmdd = arrTs[0].split("/");
                            $("#in" + arrTsyyyymmdd[0] + "-" + ("00" + arrTsyyyymmdd[1]).slice(-2) + "-" + ("00" + arrTsyyyymmdd[2]).slice(-2)).html(arrTshhmm[0] + ":" + arrTshhmm[1])
                        }
                        $.ajax({
                                type: 'GET',
                                url: url_atr + '?sn=out&q=' + email,
                                dataType: 'jsonp',
                                jsonpCallback: 'jsondata'
                            })
                            .then(
                                function(data) {
                                    // 終了の書き込み
                                    for (var idx in data) {
                                        var arrTs = new Date(data[idx].タイムスタンプ).toLocaleString("ja").split(" ");
                                        var arrTshhmm = arrTs[1].split(":");
                                        var arrTsyyyymmdd = arrTs[0].split("/");
                                        $("#out" + arrTsyyyymmdd[0] + "-" + ("00" + arrTsyyyymmdd[1]).slice(-2) + "-" + ("00" + arrTsyyyymmdd[2]).slice(-2)).html(arrTshhmm[0] + ":" + arrTshhmm[1])
                                    }
                                    // 実働計算
                                    calcTotal();
                                    $.LoadingOverlay("hide");
                                },
                                function() {
                                    console.log('error');
                                    $.LoadingOverlay("hide");
                                }
                            );
                    },
                    function() {
                        console.log('error');
                        $.LoadingOverlay("hide");
                    }
                );
        }

        // 実働計算
        function calcTotal() {
            var objTr = $("#tblAtr").find("tr");
            var tmphhtotal = 0
            var tmpmmtotal = 0
            for (var trIdx = 2; trIdx < objTr.length; trIdx++) {
                var objTd = objTr[trIdx].cells
                var inhh = objTd[1].innerText.split(":")[0];
                var inmm = objTd[1].innerText.split(":")[1];
                var outhh = objTd[2].innerText.split(":")[0];
                var outmm = objTd[2].innerText.split(":")[1];
                if (inhh != "" && inmm != "" && outhh != "" && outmm != "") {
                    var tmphh = outhh - inhh;
                    var tmpmm = outmm - inmm;
                    if (tmpmm < 0) {
                        tmphh = tmphh - 1;
                        tmpmm = 60 + tmpmm;
                    }
                    if (tmphh > 8) {
                        tmphh = tmphh - 1;
                    }
                    var subtotal = tmphh + ":" + ("00" + tmpmm).slice(-2);
                    tmphhtotal += tmphh;
                    tmpmmtotal += tmpmm;
                    $("#" + objTd[3].id).html(subtotal);
                }
            }
            tmpmmtotal = tmphhtotal * 60 + tmpmmtotal;
            $("#total").html(Math.floor(tmpmmtotal / 60) + ":" + tmpmmtotal % 60);
        }

        // ログアウト
        function signOut() {
            firebase.auth().signOut().then(function() {
                window.location.href = "login.html";
            }).catch(function(error) {
                console.log(error);
                alert("サインアウト失敗");
            });
        }

        function createAtrMonthHTML(email, userList, targetM, initF) {
            var year
            const date = new Date()
            var month = date.getMonth() + 1 + targetM
            if (month == 0) {
                year = date.getFullYear() - 1
                month = 12
            } else {
                year = date.getFullYear()
            }
            const startDate = new Date(year, month - 1, 1)
            const endDate = new Date(year, month, 0)
            const endDayCount = endDate.getDate()
            const startDay = startDate.getDay()
            var calendarHtml = '<div class="col-lg-12">'
            calendarHtml += '<div class="panel panel-default">'
            calendarHtml += '<div class="panel-heading">'
            if (targetM != 0) {
                calendarHtml += '<span style="font-size:20px" id="atrMonth_header">' + year + '年' + month + '月<a href="#" onclick="createAtrMonthHTML(\'' + email + '\',' + null + ',0)">　>></a></span><span class="pull-right"><a class="btn btn-primary btn-sm" id="btnSheetLink" href="#" onclick="exportExcel(\'xlsx\');">ダウンロード</a></span><div class="clearfix"></div>'
            } else {
                calendarHtml += '<span style="font-size:20px" id="atrMonth_header"><a href="#" onclick="createAtrMonthHTML(\'' + email + '\',' + null + ',-1)"><<　</a>' + year + '年' + month + '月</span><span class="pull-right"><a class="btn btn-primary btn-sm" id="btnSheetLink" href="#" onclick="exportExcel(\'xlsx\');">ダウンロード</a></span><div class="clearfix"></div>'
            }
            calendarHtml += '</div>'
            calendarHtml += '<div class="panel-body">'
            calendarHtml += '<div class="table-responsive" id="mypage_panel_contents">'
            calendarHtml += '<select class="form-control" id="userSelectbox" onchange="renderMyPage(this[this.selectedIndex].innerText)">'
            if ($.inArray(email, admin_user) !== -1) {
                if (initF != 0) {
                    for (var idx in userList) {
                        calendarHtml += '<option>' + userList[idx].email + '</option>';
                    }
                }
            } else {
                calendarHtml += '<option>' + email + '</option>';
            }
            calendarHtml += '</select><br>';
            calendarHtml += '<table class="table table-bordered table-hover table-sm" id="tblAtr">'
            calendarHtml += '<thead><tr>'
            calendarHtml += '<th style="width:80px;">日付</th>'
            calendarHtml += '<th style="width:80px;">開始</th>'
            calendarHtml += '<th style="width:80px;">終了</th>'
            calendarHtml += '<th style="width:80px;">実働</th>'
            calendarHtml += '<th>メモ</th>'
            calendarHtml += '</tr></thead>'
            calendarHtml += '<tfoot><tr>'
            calendarHtml += '<th colspan="3" style="text-align: right;">合計</th>'
            calendarHtml += '<th id="total" style="text-align: right;" id="total"></th>'
            calendarHtml += '<th>h</th>'
            calendarHtml += '</tr></tfoot>'
            calendarHtml += '<tbody>'
            for (var idx = 1; idx < endDayCount + 1; idx++) {
                var day = "日月火水木金土" [new Date(year + "-" + month + "-" + ("00" + idx).slice(-2)).getDay()]
                if (day == "土") {
                    calendarHtml += '<tr class="info">'
                } else if (day == "日") {
                    calendarHtml += '<tr class="danger">'
                } else if (getHoliday(year + "/" + month + "/" + idx) != "") {
                    calendarHtml += '<tr class="danger">'
                } else {
                    calendarHtml += '<tr>'
                }
                var yyyymmddId = year + "-" + ("00" + month).slice(-2) + "-" + ("00" + idx).slice(-2)
                calendarHtml += '<td>' + month + '/' + ("00" + idx).slice(-2) + '(' + day + ')' + '</td>'
                calendarHtml += '<td id="in' + yyyymmddId + '" style="text-align: right;"></td>'
                calendarHtml += '<td id="out' + yyyymmddId + '" style="text-align: right;"></td>'
                calendarHtml += '<td id="subtotal' + yyyymmddId + '" style="text-align: right;"></td>'
                calendarHtml += '<td id="memo' + yyyymmddId + '">' + getHoliday(year + "/" + month + "/" + idx) + '</td>'
                calendarHtml += '</tr>'
            }
            calendarHtml += '</tbody></table>'
            calendarHtml += '</div>'
            calendarHtml += '</div>'
            calendarHtml += '</div>'
            calendarHtml += '</div>'

            $("#row_mypage_contents").html(calendarHtml);
            if (initF != 0) {
                renderMyPage(email);
            }
        }

        function exportExcel(type, fn, dl) {
            var elt = document.getElementById('tblAtr');
            var wb = XLSX.utils.table_to_book(elt, {
                sheet: $("#atrMonth_header")[0].innerText
            });
            return dl ?
                XLSX.write(wb, {
                    bookType: type,
                    bookSST: true,
                    type: 'base64'
                }) :
                XLSX.writeFile(wb, fn || ($("#atrMonth_header")[0].innerText + '_迫間.' + (type || 'xlsx')));
        }

        function getHoliday(target) {
            var holiday = '';
            var result = $.grep(holidayList,
                function(obj, idx) {
                    return (obj.holiday == target);
                }
            );
            if (result.length != 0) {
                holiday = result[0].name
            }
            return holiday
        }

        function showtime() {
            var today = new Date();
            month = ("00" + (today.getMonth() + 1)).slice(-2);
            date = ("00" + today.getDate()).slice(-2);
            $('#datetime').html(today.getFullYear() + "-" + month + "-" + date + "(" + "日月火水木金土" [today.getDay()] + ") " + today.getHours() + ":" + ('0' + today.getMinutes()).slice(-2) + ":" + ('0' + today.getSeconds()).slice(-2));
        }
        setInterval(showtime, 1000);
    </script>
</body>

</html>